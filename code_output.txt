


---


- ãƒ•ã‚©ãƒ«ãƒ€å: .
- ãƒ•ã‚¡ã‚¤ãƒ«å: 01_powershell7_install.ps1
- å†…å®¹:
ï»¿# ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å®Ÿè¡Œã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚

# --- PowerShell 7 ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ³ã‚’ç¢ºèª ---
Write-Host "PowerShell 7 ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«çŠ¶æ³ã‚’ç¢ºèªã—ã¦ã„ã¾ã™..."
$pwshPath = Get-Command pwsh -ErrorAction SilentlyContinue

if ($pwshPath) {
    $pwshVersion = (pwsh -Command "$PSVersionTable.PSVersion").ToString()
    Write-Host "PowerShell 7 (ã¾ãŸã¯ãã‚Œä»¥é™) ãŒæ—¢ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ã¾ã™ã€‚" -ForegroundColor Green
    Write-Host "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $pwshVersion"
    Write-Host "ãƒ‘ã‚¹: $($pwshPath.Source)"
    pwsh
} else {
    Write-Warning "PowerShell 7 ã¯ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚Œã¦ã„ãªã„ã‚ˆã†ã§ã™ã€‚"
    Write-Host "Winget ã‚’ä½¿ç”¨ã—ã¦ PowerShell 7 (å®‰å®šç‰ˆ) ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è©¦ã¿ã¾ã™..."
    Write-Host "ã“ã®å‡¦ç†ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ãªå ´åˆãŒã‚ã‚Šã¾ã™ã€‚"

    # WingetãŒåˆ©ç”¨å¯èƒ½ã‹ç¢ºèª
    $wingetPath = Get-Command winget -ErrorAction SilentlyContinue
    if (-not $wingetPath) {
        Write-Error "Winget ã‚³ãƒãƒ³ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚PowerShell 7 ã‚’æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã—ã¦ãã ã•ã„ã€‚"
        Write-Host "æ‰‹å‹•ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã®æƒ…å ±: https://learn.microsoft.com/ja-jp/powershell/scripting/install/installing-powershell-on-windows"
        exit 1
    }

    # ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç®¡ç†è€…æ¨©é™ã‚’æŒã£ã¦ã„ã‚‹ã‹ç°¡æ˜“çš„ã«ç¢ºèª
    $isAdmin = ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)

    if (-not $isAdmin) {
        Write-Warning "ã‚¹ã‚¯ãƒªãƒ—ãƒˆãŒç®¡ç†è€…æ¨©é™ã§å®Ÿè¡Œã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚"
        Write-Warning "PowerShell 7 ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¯ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™ã€‚"
        $choice = Read-Host "ç¾åœ¨ã®ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ç®¡ç†è€…ã¨ã—ã¦å†èµ·å‹•ã—ã¦ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è©¦ã¿ã¾ã™ã‹ï¼Ÿ (y/n)"
        if ($choice -eq 'y') {
            Start-Process pwsh -Verb RunAs -ArgumentList "-NoProfile -File `"$($MyInvocation.MyCommand.Path)`""
            exit
        } else {
            Write-Host "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’ä¸­æ­¢ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã™ã‚‹ã‹ã€ç®¡ç†è€…ã¨ã—ã¦ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚"
            exit 1
        }
    }

    # Wingetã‚’ä½¿ã£ã¦PowerShell (å®‰å®šç‰ˆ) ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
    # "--accept-source-agreements" ã¨ "--accept-package-agreements" ã§ä¸€éƒ¨ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã§ãã‚‹å ´åˆãŒã‚ã‚‹
    $InstallCommand = "winget install --id Microsoft.PowerShell --source winget --accept-source-agreements --accept-package-agreements -h" # -h ã§ã‚µã‚¤ãƒ¬ãƒ³ãƒˆã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’è©¦ã¿ã‚‹

    Write-Host "ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’å®Ÿè¡Œã—ã¾ã™: $InstallCommand"
    Write-Host "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã«ã¯æ•°åˆ†ã‹ã‹ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆãŒè¡¨ç¤ºã•ã‚ŒãŸå ´åˆã¯æŒ‡ç¤ºã«å¾“ã£ã¦ãã ã•ã„ã€‚"

    try {
        Invoke-Expression -Command $InstallCommand -ErrorAction Stop
        Write-Host "PowerShell 7 ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚³ãƒãƒ³ãƒ‰ãŒå®Ÿè¡Œã•ã‚Œã¾ã—ãŸã€‚" -ForegroundColor Green
        Write-Host "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ãŒæˆåŠŸã—ãŸã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
        Write-Host "æ–°ã—ã„PowerShell 7ã®ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’é–‹ãã«ã¯ 'pwsh' ã¨å…¥åŠ›ã™ã‚‹ã‹ã€ã‚¹ã‚¿ãƒ¼ãƒˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰æ¤œç´¢ã—ã¦ãã ã•ã„ã€‚"

        # ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã®ç¢ºèª (ãƒ‘ã‚¹ãŒé€šã‚‹ã®ã«æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚‹)
        Write-Host "ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«å¾Œã®ç¢ºèªã‚’è©¦ã¿ã¾ã™..."
        Start-Sleep -Seconds 10 # ãƒ‘ã‚¹ãŒåæ˜ ã•ã‚Œã‚‹ã®ã‚’å¾…ã¤
        $pwshPathAfterInstall = Get-Command pwsh -ErrorAction SilentlyContinue
        if ($pwshPathAfterInstall) {
            $pwshVersionAfterInstall = (pwsh -Command "$PSVersionTable.PSVersion").ToString()
            Write-Host "PowerShell 7 ãŒæ­£å¸¸ã«ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã•ã‚ŒãŸã‚ˆã†ã§ã™ã€‚" -ForegroundColor Green
            Write-Host "ãƒãƒ¼ã‚¸ãƒ§ãƒ³: $pwshVersionAfterInstall"
            Write-Host "ãƒ‘ã‚¹: $($pwshPathAfterInstall.Source)"
        } else {
            Write-Warning "PowerShell 7 ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚"
            Write-Warning "PCã®å†èµ·å‹•ãŒå¿…è¦ãªå ´åˆã‚„ã€ãƒ‘ã‚¹ãŒåæ˜ ã•ã‚Œã‚‹ã®ã«ã‚‚ã†å°‘ã—æ™‚é–“ãŒã‹ã‹ã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚"
        }

    } catch {
        Write-Error "PowerShell 7 ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $($_.Exception.Message)"
        if ($_.Exception.ErrorRecord) {
            Write-Error ($_.Exception.ErrorRecord | Format-List * -Force | Out-String)
        }
        Write-Host "æ‰‹å‹•ã§ã®ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ã‚’æ¤œè¨ã—ã¦ãã ã•ã„: https://learn.microsoft.com/ja-jp/powershell/scripting/install/installing-powershell-on-windows"
    }
}

Write-Host ""
Write-Host "ã‚¹ã‚¯ãƒªãƒ—ãƒˆã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"


---


- ãƒ•ã‚©ãƒ«ãƒ€å: .
- ãƒ•ã‚¡ã‚¤ãƒ«å: 02_m4a_13_split.ps1
- å†…å®¹:
ï»¿$IntermediateFile = "out_1.3x.m4a" # ffmpegã‚¹ã‚¯ãƒªãƒ—ãƒˆã§ä½¿ç”¨ã™ã‚‹ä¸­é–“ãƒ•ã‚¡ã‚¤ãƒ«åã«åˆã‚ã›ã¦ãã ã•ã„

# --- ä¸­é–“ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚Œã°å‰Šé™¤ ---
if (Test-Path $IntermediateFile) {
    Write-Host "ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ$IntermediateFileã€ã‚’å‰Šé™¤ã—ã¾ã™..."
    try {
        Remove-Item -Path $IntermediateFile -Force -ErrorAction Stop
        Write-Host "ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ$IntermediateFileã€ã‚’å‰Šé™¤ã—ã¾ã—ãŸã€‚"
    } catch {
        Write-Warning "ãƒ•ã‚¡ã‚¤ãƒ«ã€Œ$IntermediateFileã€ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: $($_.Exception.Message)"
        # ã“ã“ã§ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’åœæ­¢ã™ã‚‹ã‹ã€ç¶šè¡Œã™ã‚‹ã‹ã¯è¦ä»¶ã«ã‚ˆã‚Šã¾ã™
    }
    Write-Host ""
}

$FilePatternToDelete = "output_???.m4a" # "?" ã¯ä»»æ„ã®1æ–‡å­—ã«ãƒãƒƒãƒã€‚æ•°å­—3æ¡ã«ãƒãƒƒãƒã•ã›ã‚‹ã€‚
                                       # ã¾ãŸã¯ "output_*.m4a" ã§ã‚‚å¯ (output_ã§å§‹ã¾ã‚‹å…¨ã¦ã®m4a)

# --- ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª (ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¨åŒã˜å ´æ‰€ã‚’æƒ³å®š) ---
$TargetDirectory = ".\" # ã‚«ãƒ¬ãƒ³ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
# ã‚‚ã—ç‰¹å®šã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’æŒ‡å®šã™ã‚‹å ´åˆã¯ãƒ•ãƒ«ãƒ‘ã‚¹ã§:
# $TargetDirectory = "C:\path\to\your\audio_files"

Write-Host "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€Œ$((Resolve-Path $TargetDirectory).Path)ã€å†…ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã€Œ$FilePatternToDeleteã€ã«ä¸€è‡´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ¤œç´¢ãƒ»å‰Šé™¤ã—ã¾ã™..."

# ãƒ‘ã‚¿ãƒ¼ãƒ³ã«ä¸€è‡´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å–å¾—
$FilesToDelete = Get-ChildItem -Path $TargetDirectory -Filter $FilePatternToDelete -File # -File ã§ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å¯¾è±¡

if ($FilesToDelete.Count -gt 0) {
    Write-Host "$($FilesToDelete.Count) å€‹ã®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚"
    foreach ($File in $FilesToDelete) {
        $FilePath = $File.FullName
        Write-Host "  å‰Šé™¤ä¸­: $FilePath"
        try {
            Remove-Item -Path $FilePath -Force -ErrorAction Stop
            Write-Host "    å‰Šé™¤æˆåŠŸ: $FilePath" -ForegroundColor Green
        } catch {
            Write-Error "    å‰Šé™¤å¤±æ•—: $FilePath - ã‚¨ãƒ©ãƒ¼: $($_.Exception.Message)"
        }
    }
    Write-Host "æŒ‡å®šã•ã‚ŒãŸãƒ‘ã‚¿ãƒ¼ãƒ³ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®å‰Šé™¤å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"
} else {
    Write-Host "ãƒ‘ã‚¿ãƒ¼ãƒ³ã€Œ$FilePatternToDeleteã€ã«ä¸€è‡´ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚"
}

Write-Host ""
Write-Host ""

# --- ã‚³ãƒãƒ³ãƒ‰1: 1.3å€é€Ÿã«ã™ã‚‹ ---
Write-Host "GeminiãŒé–“é•ã‚ãªã„ç¨‹åº¦ã«æ—©ãã—ã¦ã€ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã‚’å°ã•ãã™ã‚‹ã€‚"
Write-Host "ã‚³ãƒãƒ³ãƒ‰1: input.m4a ã‚’1.3å€é€Ÿã«ã—ã¦ out_1.3x.m4a ã«ä¿å­˜ã—ã¾ã™..."
ffmpeg -i input.m4a -filter:a "atempo=1.3" -vn out_1.3x.m4a

Write-Host "ã‚³ãƒãƒ³ãƒ‰1 å®Œäº†ã€‚"
Write-Host "" # æ”¹è¡Œ

# --- ã‚³ãƒãƒ³ãƒ‰2: åˆ†å‰²ã™ã‚‹ ---
Write-Host "Geminiæ–‡å­—èµ·ã“ã—ãŒã€ï¼—åˆ†ã§ã¯ã‚¨ãƒ©ãƒ¼ã€€ï¼–åˆ†ãªã‚‰OKã ãŒã€ä½™è£•ã‚’è¦‹ã¦ï¼”åˆ†(240ç§’)ã«åˆ†å‰²ã™ã‚‹"
Write-Host "ã‚³ãƒãƒ³ãƒ‰2: out_1.3x.m4a ã‚’5åˆ†(300ç§’)ã”ã¨ã« output_%03d.m4a ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ã§åˆ†å‰²ã—ã¾ã™..."
ffmpeg -i out_1.3x.m4a -f segment -segment_time 240 -c copy output_%03d.m4a

Write-Host "ã‚³ãƒãƒ³ãƒ‰2 å®Œäº†ã€‚"
Write-Host ""

Write-Host "å…¨ã¦ã®ffmpegå‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚"


---


- ãƒ•ã‚©ãƒ«ãƒ€å: .
- ãƒ•ã‚¡ã‚¤ãƒ«å: 03_dify_mojiokosi2.ps1
- å†…å®¹:
ï»¿# Ensure output encoding is UTF-8, can be helpful
# $OutputEncoding = [System.Text.Encoding]::UTF8

# --- Dify API Settings (â˜… Replace with your actual values) ---
$DifyApiBaseUrl = "https://api.dify.ai/v1" # Base URL of your Dify instance
$DifyFileUploadEndpoint = "$DifyApiBaseUrl/files/upload"
$DifyWorkflowRunEndpoint = "$DifyApiBaseUrl/workflows/run" # Workflow endpoint
$DifyApiKey = "app-eAx08D3rouMzJKNBKfFZGupk" # â˜… Your Dify App API Key
$UserIdentifier = "powershell_user_$(Get-Random)" # Unique user ID for each run (optional)

# --- Dify Workflow Variable Names (â˜… As per your Dify setup) ---
$DifyWorkflowAudioInputVariable = "input"    # Variable name for audio file input in workflow
$DifyWorkflowOutputVariable = "text"      # Variable name for transcription output in workflow

# --- Retry Settings for Workflow Execution ---
$MaxRetriesWorkflow = 1       # Max number of retries (total attempts = 1 + MaxRetries)
$RetrySleepSecondsWorkflow = 5 # Seconds to wait before retrying

# --- Target File Pattern and Location (â˜… Modify as needed) ---
$FilePattern = "output_*.m4a"
$AudioFilesDirectory = ".\" # If in the same directory as the script. Use full path otherwise (e.g., "C:\path\to\audio_files")

# --- Script Output Directory ---
$OutputDirectory = ".\dify_transcripts_workflow" # Directory to save results

# â˜…â˜…â˜… ã“ã“ã‹ã‚‰è¿½åŠ  â˜…â˜…â˜…
# Check if the output directory exists and delete it recursively if it does
if (Test-Path $OutputDirectory) {
    Write-Host "æ—¢å­˜ã®å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€Œ$OutputDirectoryã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¸­èº«ã”ã¨å‰Šé™¤ã—ã¾ã™..."
    try {
        Remove-Item -Path $OutputDirectory -Recurse -Force -ErrorAction Stop
        Write-Host "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€Œ$OutputDirectoryã€ã‚’æ­£å¸¸ã«å‰Šé™¤ã—ã¾ã—ãŸã€‚" -ForegroundColor Green
    } catch {
        Write-Error "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã€Œ$OutputDirectoryã€ã®å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: $($_.Exception.Message)"
        # ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ãŸå ´åˆã€ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’ç¶šè¡Œã™ã‚‹ã‹åœæ­¢ã™ã‚‹ã‹ã‚’æ±ºå®š
        # ã“ã“ã§ã¯ç¶šè¡Œã™ã‚‹ãŒã€å ´åˆã«ã‚ˆã£ã¦ã¯ exit 1 ãªã©ã§åœæ­¢ã™ã‚‹ã“ã¨ã‚‚æ¤œè¨
        Write-Warning "ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªå‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸãŒã€å‡¦ç†ã‚’ç¶šè¡Œã—ã¾ã™ã€‚"
    }
    Write-Host ""
}
# â˜…â˜…â˜… ã“ã“ã¾ã§è¿½åŠ  â˜…â˜…â˜…

if (-not (Test-Path $OutputDirectory)) {
    New-Item -ItemType Directory -Path $OutputDirectory | Out-Null
}

# --- Headers ---
$FileUploadAuthHeader = @{ # For Step A
    "Authorization" = "Bearer $DifyApiKey"
}
$WorkflowRunHeaders = @{ # For Step B, Content-Type is application/json
    "Authorization" = "Bearer $DifyApiKey"
    "Content-Type"  = "application/json"
}

# --- Find Target Files ---
$AudioFiles = Get-ChildItem -Path $AudioFilesDirectory -Filter $FilePattern

if ($AudioFiles.Count -eq 0) {
    Write-Warning "No target files found: $AudioFilesDirectory\$FilePattern"
    exit
}

Write-Host "Starting to send files to Dify Workflow API for transcription..."
Write-Host ""

foreach ($AudioFile in $AudioFiles) {
    $CurrentAudioFilePath = $AudioFile.FullName
    $FileNameNoExt = $AudioFile.BaseName # Filename without extension

    Write-Host "--------------------------------------------------"
    Write-Host "Processing file: $CurrentAudioFilePath"

    # --- Step A: File Upload (Using Invoke-WebRequest for MIME type control) ---
    Write-Host "  Step A: Uploading file '$($AudioFile.Name)' with Invoke-WebRequest..."
    $UploadResponsePath = Join-Path -Path $OutputDirectory -ChildPath "upload_response_$FileNameNoExt.json"
    $UploadFileId = $null

    try {
        # ... (ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã®ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ãªã— - å‰å›ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨) ...
        $FileBytes = [System.IO.File]::ReadAllBytes($CurrentAudioFilePath)
        $FileName = $AudioFile.Name
        $Boundary = "---------------------------$([System.Guid]::NewGuid().ToString())"
        $CRLF = "`r`n"
        $BodyLines = @(
            "--$Boundary",
            "Content-Disposition: form-data; name=`"user`"$CRLF",
            $UserIdentifier,
            "--$Boundary",
            "Content-Disposition: form-data; name=`"file`"; filename=`"$FileName`"",
            "Content-Type: audio/m4a$CRLF"
        )
        $BodyPrefixString = ($BodyLines -join $CRLF) + $CRLF
        $BodySuffixString = "$CRLF--$Boundary--$CRLF"
        $PrefixBytes = [System.Text.Encoding]::UTF8.GetBytes($BodyPrefixString)
        $SuffixBytes = [System.Text.Encoding]::UTF8.GetBytes($BodySuffixString)
        $FullRequestBodyBytes = New-Object byte[] ($PrefixBytes.Length + $FileBytes.Length + $SuffixBytes.Length)
        [System.Array]::Copy($PrefixBytes, 0, $FullRequestBodyBytes, 0, $PrefixBytes.Length)
        [System.Array]::Copy($FileBytes, 0, $FullRequestBodyBytes, $PrefixBytes.Length, $FileBytes.Length)
        [System.Array]::Copy($SuffixBytes, 0, $FullRequestBodyBytes, ($PrefixBytes.Length + $FileBytes.Length), $SuffixBytes.Length)
        $UploadContentType = "multipart/form-data; boundary=`"$Boundary`""
        $RawUploadResponse = Invoke-WebRequest -Uri $DifyFileUploadEndpoint -Method Post -Headers $FileUploadAuthHeader -Body $FullRequestBodyBytes -ContentType $UploadContentType -UseBasicParsing -SkipHttpErrorCheck
        if ($RawUploadResponse.StatusCode -ge 400) {
            Write-Error "  Error: File upload failed with status code $($RawUploadResponse.StatusCode)."
            $ErrorBody = $RawUploadResponse.Content
            Write-Warning "    Error response body (Upload): $ErrorBody"
            $ErrorBody | Out-File -FilePath $UploadResponsePath -Encoding UTF8
            Continue
        }
        $UploadResponse = $RawUploadResponse.Content | ConvertFrom-Json
        $UploadResponse | ConvertTo-Json -Depth 5 | Out-File -FilePath $UploadResponsePath -Encoding UTF8
        $UploadFileId = $UploadResponse.id
        if (-not $UploadFileId) {
            Write-Error "  Error: Failed to get upload_file_id. Check response: $UploadResponsePath"
            Continue
        }
        Write-Host "    Upload successful. upload_file_id: $UploadFileId, Sent MIME Type for file: audio/m4a"
    } catch {
        Write-Error "  Error: Unexpected exception during file upload: $($_.Exception.Message)"
        Continue
    }

    # --- Step B: Run Workflow (Transcription Request) with Retry Logic ---
    Write-Host "  Step B: Running workflow (upload_file_id: $UploadFileId)..."
    $WorkflowPayloadPath = Join-Path -Path $OutputDirectory -ChildPath "workflow_payload_$FileNameNoExt.json"
    $WorkflowResponsePath = Join-Path -Path $OutputDirectory -ChildPath "workflow_response_$FileNameNoExt.json"

    $PayloadInputs = @{
        "$DifyWorkflowAudioInputVariable" = @{
            type             = "audio"
            transfer_method  = "local_file"
            upload_file_id   = $UploadFileId
        }
    }
    $WorkflowPayload = @{
        inputs         = $PayloadInputs
        response_mode  = "blocking"
        user           = $UserIdentifier
    }
    $WorkflowPayloadJson = $WorkflowPayload | ConvertTo-Json -Depth 5
    $WorkflowPayloadJson | Out-File -FilePath $WorkflowPayloadPath -Encoding UTF8

    $RetryCountWorkflow = 0
    $WorkflowSucceeded = $false

    while ($RetryCountWorkflow -le $MaxRetriesWorkflow -and -not $WorkflowSucceeded) {
        if ($RetryCountWorkflow -gt 0) {
            Write-Warning "    Retrying workflow execution ($($RetryCountWorkflow)/$($MaxRetriesWorkflow)). Waiting $($RetrySleepSecondsWorkflow) seconds..."
            Start-Sleep -Seconds $RetrySleepSecondsWorkflow
        }
        Write-Host "    Attempting API call (Attempt $($RetryCountWorkflow + 1))..."
        try {
            $RawWorkflowResponse = Invoke-RestMethod -Uri $DifyWorkflowRunEndpoint -Method Post -Headers $WorkflowRunHeaders -Body $WorkflowPayloadJson -SkipHttpErrorCheck

            # Check for Dify's specific error structure OR if it's a non-successful workflow status
            if ($RawWorkflowResponse.code -and ($RawWorkflowResponse.status -ge 400)) { # Direct API error (e.g., 400, 500, 504)
                Write-Error "    Error: Workflow execution failed (Dify error code: $($RawWorkflowResponse.code) - Status: $($RawWorkflowResponse.status)). Message: $($RawWorkflowResponse.message)"
                $ErrorBodyJson = $RawWorkflowResponse | ConvertTo-Json -Depth 10
                Write-Warning "      Error response body (Workflow): $ErrorBodyJson"
                $ErrorBodyJson | Out-File -FilePath $WorkflowResponsePath -Encoding UTF8 # Overwrite with last error
                if ($RawWorkflowResponse.status -lt 500) { # For 4xx errors, retrying might not help
                    Write-Warning "      Client-side error ($($RawWorkflowResponse.status)), not retrying."
                    break # Exit retry loop
                }
            } elseif ($RawWorkflowResponse.data -and $RawWorkflowResponse.data.status -and $RawWorkflowResponse.data.status -ne 'succeeded') { # Workflow executed but failed internally
                Write-Error "    Error: Workflow execution indicated failure (status: $($RawWorkflowResponse.data.status)). Error: $($RawWorkflowResponse.data.error)"
                $ErrorBodyJson = $RawWorkflowResponse | ConvertTo-Json -Depth 10
                Write-Warning "      Dify response (Workflow): $ErrorBodyJson"
                $ErrorBodyJson | Out-File -FilePath $WorkflowResponsePath -Encoding UTF8 # Overwrite
                if ($RawWorkflowResponse.data.status -eq 'failed') { # Definite failure
                     Write-Warning "      Workflow status 'failed', not retrying."
                     break # Exit retry loop
                }
            } else { # Potentially successful or unexpected good response
                $RawWorkflowResponse | ConvertTo-Json -Depth 10 | Out-File -FilePath $WorkflowResponsePath -Encoding UTF8
                Write-Host "    Workflow API call potentially successful. Response saved to $WorkflowResponsePath"

                if ($RawWorkflowResponse.data -and $RawWorkflowResponse.data.outputs -and $RawWorkflowResponse.data.outputs.$DifyWorkflowOutputVariable -ne $null) {
                    $Transcription = $RawWorkflowResponse.data.outputs.$DifyWorkflowOutputVariable
                    Write-Host "    --- Transcription Result ---"
                    Write-Host $Transcription
                    $WorkflowSucceeded = $true # Set success flag
                } else {
                    Write-Warning "    Could not find transcription in response: data.outputs.$DifyWorkflowOutputVariable"
                    Write-Warning "    Check $WorkflowResponsePath for the full response structure."
                    # Consider if this specific case should be retried or marked as failure.
                    # For now, it will retry if $WorkflowSucceeded is not set.
                }
            }
        } catch {
            Write-Error "    Error: Unexpected exception during workflow execution (Attempt $($RetryCountWorkflow + 1)): $($_.Exception.Message)"
            # This catch is for network errors etc., before a Dify JSON response is received.
        }

        if (-not $WorkflowSucceeded -and $RetryCountWorkflow -lt $MaxRetriesWorkflow) {
            Write-Host "    Workflow attempt failed. Will retry if applicable."
        }
        $RetryCountWorkflow++
    } # End of while loop

    if (-not $WorkflowSucceeded) {
        Write-Error "  Step B: Workflow execution ultimately failed for file '$($AudioFile.Name)' after $($MaxRetriesWorkflow + 1) attempts."
    }
    Write-Host ""
} # End of foreach loop


# --- å…¨ã¦ã®æ–‡å­—èµ·ã“ã—çµæœã‚’1ã¤ã®ãƒ†ã‚­ã‚¹ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹ ---
# ... (ã“ã®éƒ¨åˆ†ã®ã‚³ãƒ¼ãƒ‰ã¯å¤‰æ›´ãªã— - å‰å›ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚’ä½¿ç”¨) ...
$CombinedTranscriptionFile = Join-Path -Path $OutputDirectory -ChildPath "all_transcriptions.txt"
Write-Host "--------------------------------------------------"
Write-Host "å…¨ã¦ã®æ–‡å­—èµ·ã“ã—çµæœã‚’ $CombinedTranscriptionFile ã«ã¾ã¨ã‚ã¦ã„ã¾ã™..."
if (Test-Path $CombinedTranscriptionFile) {
    Remove-Item $CombinedTranscriptionFile
}
Get-ChildItem -Path $OutputDirectory -Filter "workflow_response_*.json" | ForEach-Object {
    $ResponseFilePath = $_.FullName
    $OriginalFileName = $_.BaseName -replace "workflow_response_", ""
    Write-Host "  å‡¦ç†ä¸­: $ResponseFilePath (å…ƒãƒ•ã‚¡ã‚¤ãƒ«: $OriginalFileName.m4a)"
    try {
        $JsonResponse = Get-Content -Path $ResponseFilePath -Raw | ConvertFrom-Json -ErrorAction Stop
        if ($JsonResponse.data -and $JsonResponse.data.outputs -and $JsonResponse.data.outputs.$DifyWorkflowOutputVariable -ne $null) {
            $TranscriptionText = $JsonResponse.data.outputs.$DifyWorkflowOutputVariable
            #Add-Content -Path $CombinedTranscriptionFile -Value "--- Transcription for: $OriginalFileName.m4a ---"
            Add-Content -Path $CombinedTranscriptionFile -Value $TranscriptionText
            Add-Content -Path $CombinedTranscriptionFile -Value ""
            Add-Content -Path $CombinedTranscriptionFile -Value ""
        } elseif ($JsonResponse.code -and $JsonResponse.message) {
            Add-Content -Path $CombinedTranscriptionFile -Value "--- Error for: $OriginalFileName.m4a ---"
            Add-Content -Path $CombinedTranscriptionFile -Value "Error Code: $($JsonResponse.code)"
            Add-Content -Path $CombinedTranscriptionFile -Value "Error Message: $($JsonResponse.message)"
            Add-Content -Path $CombinedTranscriptionFile -Value ""
            Add-Content -Path $CombinedTranscriptionFile -Value "--------------------------------------------------"
            Add-Content -Path $CombinedTranscriptionFile -Value ""
        } else {
            Write-Warning "    $ResponseFilePath ã‹ã‚‰æ–‡å­—èµ·ã“ã—çµæœã‚’æŠ½å‡ºã§ãã¾ã›ã‚“ã§ã—ãŸã€‚å†…å®¹ã¯æˆåŠŸã—ãŸãƒ¬ã‚¹ãƒãƒ³ã‚¹å½¢å¼ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚"
            Add-Content -Path $CombinedTranscriptionFile -Value "--- No valid transcription found for: $OriginalFileName.m4a ---"
            Add-Content -Path $CombinedTranscriptionFile -Value ""
            Add-Content -Path $CombinedTranscriptionFile -Value "--------------------------------------------------"
            Add-Content -Path $CombinedTranscriptionFile -Value ""
        }
    } catch {
        Write-Warning "    $ResponseFilePath ã®èª­ã¿è¾¼ã¿ã¾ãŸã¯JSONãƒ‘ãƒ¼ã‚¹ã«å¤±æ•—ã—ã¾ã—ãŸ: $($_.Exception.Message)"
        Add-Content -Path $CombinedTranscriptionFile -Value "--- Failed to process: $OriginalFileName.m4a (Error reading or parsing JSON) ---"
        Add-Content -Path $CombinedTranscriptionFile -Value ""
        Add-Content -Path $CombinedTranscriptionFile -Value "--------------------------------------------------"
        Add-Content -Path $CombinedTranscriptionFile -Value ""
    }
}
if (Test-Path $CombinedTranscriptionFile) {
    Write-Host "æ–‡å­—èµ·ã“ã—çµæœãŒ $CombinedTranscriptionFile ã«ä¿å­˜ã•ã‚Œã¾ã—ãŸã€‚"
} else {
    Write-Warning "$CombinedTranscriptionFile ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã§ã—ãŸã€‚å‡¦ç†å¯¾è±¡ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‹ã£ãŸã‹ã€ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚"
}
Write-Host "--------------------------------------------------"
Write-Host "All processing complete."


---


- ãƒ•ã‚©ãƒ«ãƒ€å: .
- ãƒ•ã‚¡ã‚¤ãƒ«å: [æœ¬ç•ª]æ–‡å­—èµ·ã“ã—20250510.yml
- å†…å®¹:
app:
  description: ''
  icon: ğŸ¤–
  icon_background: '#FFEAD5'
  mode: workflow
  name: '[æœ¬ç•ª]æ–‡å­—èµ·ã“ã—20250510'
  use_icon_as_answer_icon: false
dependencies:
- current_identifier: null
  type: marketplace
  value:
    marketplace_plugin_unique_identifier: langgenius/gemini:0.1.5@012c9e0467a11910db974e0436348e93a376fdc96381946a3db2c56708377381
kind: app
version: 0.2.0
workflow:
  conversation_variables: []
  environment_variables: []
  features:
    file_upload:
      allowed_file_extensions:
      - .JPG
      - .JPEG
      - .PNG
      - .GIF
      - .WEBP
      - .SVG
      allowed_file_types:
      - image
      allowed_file_upload_methods:
      - local_file
      - remote_url
      enabled: false
      fileUploadConfig:
        audio_file_size_limit: 50
        batch_count_limit: 5
        file_size_limit: 15
        image_file_size_limit: 10
        video_file_size_limit: 100
        workflow_file_upload_limit: 10
      image:
        enabled: false
        number_limits: 3
        transfer_methods:
        - local_file
        - remote_url
      number_limits: 3
    opening_statement: ''
    retriever_resource:
      enabled: true
    sensitive_word_avoidance:
      enabled: false
    speech_to_text:
      enabled: false
    suggested_questions: []
    suggested_questions_after_answer:
      enabled: false
    text_to_speech:
      enabled: false
      language: ''
      voice: ''
  graph:
    edges:
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: start
        targetType: llm
      id: 1746846958118-source-1746846961452-target
      source: '1746846958118'
      sourceHandle: source
      target: '1746846961452'
      targetHandle: target
      type: custom
      zIndex: 0
    - data:
        isInIteration: false
        isInLoop: false
        sourceType: llm
        targetType: end
      id: 1746846961452-source-1746847044403-target
      source: '1746846961452'
      sourceHandle: source
      target: '1746847044403'
      targetHandle: target
      type: custom
      zIndex: 0
    nodes:
    - data:
        desc: ''
        selected: false
        title: é–‹å§‹
        type: start
        variables:
        - allowed_file_extensions: []
          allowed_file_types:
          - audio
          allowed_file_upload_methods:
          - local_file
          - remote_url
          label: input
          max_length: 48
          options: []
          required: true
          type: file
          variable: input
      height: 89
      id: '1746846958118'
      position:
        x: 80
        y: 282
      positionAbsolute:
        x: 80
        y: 282
      selected: true
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        context:
          enabled: false
          variable_selector: []
        desc: ''
        model:
          completion_params:
            temperature: 0.7
          mode: chat
          name: gemini-2.0-flash-exp
          provider: langgenius/gemini/google
        prompt_template:
        - id: 1c2939d3-7366-40fd-9ee0-b46a158d0fc2
          role: system
          text: ãƒ“ã‚¸ãƒ§ãƒ³ã«æ ¼ç´ã•ã‚ŒãŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–‡å­—èµ·ã“ã—ã—ã¦ãã ã•ã„
        - id: 24012c5f-067f-45ab-ba82-515c55fce8a2
          role: user
          text: ãƒ“ã‚¸ãƒ§ãƒ³ã«æ ¼ç´ã•ã‚ŒãŸéŸ³å£°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ–‡å­—èµ·ã“ã—ã—ã¦ãã ã•ã„
        selected: false
        title: LLM
        type: llm
        variables: []
        vision:
          configs:
            detail: high
            variable_selector:
            - '1746846958118'
            - input
          enabled: true
      height: 89
      id: '1746846961452'
      position:
        x: 384
        y: 282
      positionAbsolute:
        x: 384
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    - data:
        desc: ''
        outputs:
        - value_selector:
          - '1746846961452'
          - text
          variable: text
        selected: false
        title: çµ‚äº†
        type: end
      height: 89
      id: '1746847044403'
      position:
        x: 688
        y: 282
      positionAbsolute:
        x: 688
        y: 282
      selected: false
      sourcePosition: right
      targetPosition: left
      type: custom
      width: 244
    viewport:
      x: -29
      y: -43
      zoom: 1
